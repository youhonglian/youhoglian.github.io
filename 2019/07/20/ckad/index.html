<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>Kubernetes Started - Youuu</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.jpg"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/youhonglian"><span>Github</span></a></li><li><a href="https://segmentfault.com/u/youzhiwan"><span>SegmentFault</span></a></li><li><a href="https://segmentfault.com/u/youzhiwan/notes"><span>我的笔记</span></a></li><li><a href="http://os3fgs3e7.bkt.clouddn.com/%E6%B8%B8%E6%B4%AA%E8%8E%B2web%E5%89%8D%E7%AB%AF.pdf"><span>关于我</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://callfiles.ueibo.com/hexo-theme-laughing/post_background.jpg"><div class="post-title"><h1 class="title">Kubernetes Started</h1><ul class="meta"><li><i class="icon icon-author"></i>Youuu</li><li><i class="icon icon-clock"></i>44 Minutes</li><li><i class="icon icon-calendar"></i>July 20, 2019</li></ul></div></div><div class="article-content" style="max-width:800px"><h3 id="1-为pod-container配置env参数，用-DEMO-GREETING-命名参数；"><a href="#1-为pod-container配置env参数，用-DEMO-GREETING-命名参数；" class="headerlink" title="1. 为pod/container配置env参数，用 DEMO_GREETING 命名参数；"></a>1. 为pod/container配置env参数，用 DEMO_GREETING 命名参数；</h3><ul>
<li>env 的名称要大写，否则 printenv 打印不出来，且不报错</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod </span><br><span class="line">metadata:</span><br><span class="line">  name: demo-green</span><br><span class="line">  labels:</span><br><span class="line">    purpose: demonstrate-envars</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: envar-demo-container</span><br><span class="line">    image: nginx</span><br><span class="line">    env:</span><br><span class="line">    - name: DEMO_GREETING</span><br><span class="line">      value: &apos;hello from the environment&apos;</span><br><span class="line"></span><br><span class="line">kubectl exec -it demo3 -- sh</span><br><span class="line">printenv | grep DEMO_GREETING</span><br></pre></td></tr></table></figure>
<h3 id="2-为pod-container配置env参数，使用-configMap-为-config1；"><a href="#2-为pod-container配置env参数，使用-configMap-为-config1；" class="headerlink" title="2. 为pod/container配置env参数，使用 configMap 为 config1；"></a>2. 为pod/container配置env参数，使用 configMap 为 config1；</h3><ul>
<li>使用了 congfig 的所有参数则不需要为 env 在设置名称；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: demo-green</span><br><span class="line">  labels:</span><br><span class="line">    purpose: demonstrate-envars</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: envar-demo-container</span><br><span class="line">    image: nginx</span><br><span class="line">    envFrom:</span><br><span class="line">      configMapRef:</span><br><span class="line">      - name: config1</span><br></pre></td></tr></table></figure>
<h3 id="3-为pod-container配置env参数，使用-configMap-为-config1-的-key1"><a href="#3-为pod-container配置env参数，使用-configMap-为-config1-的-key1" class="headerlink" title="3. 为pod/container配置env参数，使用 configMap 为 config1 的 key1;"></a>3. 为pod/container配置env参数，使用 configMap 为 config1 的 key1;</h3><ul>
<li>使用 configMap 种的某项参数时，需要为 env 设置名称；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: demo-green</span><br><span class="line">  labels:</span><br><span class="line">    purpose: demonstrate-envars</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: envar-demo-container</span><br><span class="line">    image: nginx</span><br><span class="line">    envFrom:</span><br><span class="line">    - name: env1</span><br><span class="line">      configMapKeyRef:</span><br><span class="line">      - name: config1</span><br><span class="line">        key: key1</span><br></pre></td></tr></table></figure>
<h3 id="4-使用环境变量来定义参数"><a href="#4-使用环境变量来定义参数" class="headerlink" title="4. 使用环境变量来定义参数"></a>4. 使用环境变量来定义参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: demo-green</span><br><span class="line">  labels:</span><br><span class="line">    purpose: demonstrate-envars</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: envar-demo-container</span><br><span class="line">    image: nginx</span><br><span class="line">    env:</span><br><span class="line">    - name: MESSAGE</span><br><span class="line">      value: &apos;hello world&apos;</span><br><span class="line">    command: [&apos;/bin/echo&apos;]</span><br><span class="line">    args: [&apos;$(MESSAGE)&apos;]</span><br></pre></td></tr></table></figure>
<h3 id="5-为container配置args-command参数；"><a href="#5-为container配置args-command参数；" class="headerlink" title="5. 为container配置args/command参数；"></a>5. 为container配置args/command参数；</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: demo-green</span><br><span class="line">  labels:</span><br><span class="line">    purpose: demonstrate-envars</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: envar-demo-container</span><br><span class="line">    image: nginx</span><br><span class="line">    args: [&apos;HOSTNAME&apos;]</span><br><span class="line">    commands: [&apos;printenv&apos;]</span><br></pre></td></tr></table></figure>
<h3 id="6-将-pod-分配给-node"><a href="#6-将-pod-分配给-node" class="headerlink" title="6. 将 pod 分配给 node"></a>6. 将 pod 分配给 node</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  nodeSelector:</span><br><span class="line">    nodeKey: nodeValue</span><br><span class="line">  containers:</span><br><span class="line">  - name: envar-demo-container</span><br><span class="line">    image: nginx1</span><br></pre></td></tr></table></figure>
<h3 id="7-记录基础日志"><a href="#7-记录基础日志" class="headerlink" title="7. 记录基础日志"></a>7. 记录基础日志</h3><ul>
<li>如果容器崩溃，可以使用 kubectl logs –previous</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: counter</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: count</span><br><span class="line">    image: busybox</span><br><span class="line">    args: [&apos;/bin/sh&apos;, &apos;-c&apos;, &apos;i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 1; done&apos;]</span><br><span class="line"></span><br><span class="line">kubectl logs counter</span><br></pre></td></tr></table></figure>
<h3 id="8-使用-sidecar-记录日志"><a href="#8-使用-sidecar-记录日志" class="headerlink" title="8. 使用 sidecar 记录日志"></a>8. 使用 sidecar 记录日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: counter</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: my-volume</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">  containers:</span><br><span class="line">  - name: count</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">    - /bin/sh</span><br><span class="line">    - -c</span><br><span class="line">    - &gt;</span><br><span class="line">      i=0;</span><br><span class="line">      while true;</span><br><span class="line">      do</span><br><span class="line">        echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/1.log;</span><br><span class="line">        echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/2.log;</span><br><span class="line">        i=$((i+1));</span><br><span class="line">        sleep 1;</span><br><span class="line">      done</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: my-volume</span><br><span class="line">      mountPath: /var/log</span><br><span class="line">  - name: count-agent1</span><br><span class="line">    image: busybox</span><br><span class="line">    args: [&apos;/bin/sh&apos;, &apos;-c&apos;, &apos;tail -n+1 -f /var/log/1.log&apos;]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: my-volume</span><br><span class="line">      mountPath: /var/log   </span><br><span class="line">  - name: count-agent2</span><br><span class="line">    image: busybox</span><br><span class="line">    args: [&apos;/bin/sh&apos;, &apos;-c&apos;, &apos;tail -n+1 -f /var/log/2.log&apos;]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: my-volume</span><br><span class="line">      mountPath: /var/log</span><br></pre></td></tr></table></figure>
<h3 id="9-为-pod-设置-ServiceAccount"><a href="#9-为-pod-设置-ServiceAccount" class="headerlink" title="9. 为 pod 设置 ServiceAccount"></a>9. 为 pod 设置 ServiceAccount</h3><p>kubectl create sa sa1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: counter</span><br><span class="line">spec:</span><br><span class="line">  serviceAccountName: sa1</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br></pre></td></tr></table></figure>
<h3 id="10-为-ServiceAccount-添加-ImagePullSecret"><a href="#10-为-ServiceAccount-添加-ImagePullSecret" class="headerlink" title="10. 为 ServiceAccount 添加 ImagePullSecret"></a>10. 为 ServiceAccount 添加 ImagePullSecret</h3><ul>
<li>创建 ImagePullSecret</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry test2 --docker-server=DOCKER_REGISTRY_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL</span><br></pre></td></tr></table></figure>
<ul>
<li>添加到 ServiceAccount</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: test2</span><br><span class="line">  namespace: default</span><br><span class="line">secrets:</span><br><span class="line">- name: default-token-uudge</span><br><span class="line">imagePullSecrets:</span><br><span class="line">- name: myregistrykey</span><br></pre></td></tr></table></figure>
<ul>
<li>为 pod 配置 serviceAccount</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: demo-green</span><br><span class="line">  labels:</span><br><span class="line">    purpose: demonstrate-envars</span><br><span class="line">spec:</span><br><span class="line">  serviceAccountName: test2</span><br><span class="line">  containers:</span><br><span class="line">  - name: envar-demo-container</span><br><span class="line">    image: nginx</span><br></pre></td></tr></table></figure>
<h3 id="11-为-deploy-rs-扩容或缩放"><a href="#11-为-deploy-rs-扩容或缩放" class="headerlink" title="11. 为 deploy/rs 扩容或缩放"></a>11. 为 deploy/rs 扩容或缩放</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deploy/foo --replicas=3</span><br><span class="line">kubectl scale rs/foo --replicas=3</span><br></pre></td></tr></table></figure>
<h3 id="12-为-deploy-添加自动伸缩"><a href="#12-为-deploy-添加自动伸缩" class="headerlink" title="12. 为 deploy 添加自动伸缩"></a>12. 为 deploy 添加自动伸缩</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl autoscale deploy nginx --min=5 --max=10 --cpu-percent=80</span><br></pre></td></tr></table></figure>
<h3 id="13-给-node-打污点"><a href="#13-给-node-打污点" class="headerlink" title="13. 给 node 打污点"></a>13. 给 node 打污点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 key1=value1:NoSchedule</span><br><span class="line">kubectl taint nodes node1 key1:NoSchedule-</span><br></pre></td></tr></table></figure>
<h3 id="14-给-pod-添加容忍"><a href="#14-给-pod-添加容忍" class="headerlink" title="14. 给 pod 添加容忍"></a>14. 给 pod 添加容忍</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mypod</span><br><span class="line">spec:</span><br><span class="line">  tolerations:</span><br><span class="line">  - key: &apos;key1&apos;</span><br><span class="line">    operator: &quot;Equal&quot;</span><br><span class="line">    value: &apos;value1&apos;</span><br><span class="line">    effect: &apos;NoSchedule&apos;</span><br><span class="line">    tolerationSeconds: 3600</span><br><span class="line">  containers:</span><br><span class="line">    - name: myfrontend</span><br><span class="line">      image: nginx</span><br></pre></td></tr></table></figure>
<h3 id="15-为-pod-添加持久卷"><a href="#15-为-pod-添加持久卷" class="headerlink" title="15. 为 pod 添加持久卷"></a>15. 为 pod 添加持久卷</h3><ul>
<li>创建文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;hello world&apos; &gt; /mnt/data</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 pv</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: normal</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 pvc</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: normal</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 8Gi</span><br></pre></td></tr></table></figure>
<ul>
<li>为 pod 绑定 pvc</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mypod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">    - name: mypd</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: pvc</span><br><span class="line">  containers:</span><br><span class="line">    - name: myfrontend</span><br><span class="line">      image: nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">      - name: mypd</span><br><span class="line">        mountPath: &quot;/var/www/html&quot;</span><br></pre></td></tr></table></figure>
<h3 id="16-给-pod-配置存活检查"><a href="#16-给-pod-配置存活检查" class="headerlink" title="16. 给 pod 配置存活检查"></a>16. 给 pod 配置存活检查</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    test: liveness</span><br><span class="line">  name: liveness-exec</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: k8s.gcr.io/busybox</span><br><span class="line">    args:</span><br><span class="line">    - /bin/sh</span><br><span class="line">    - -c</span><br><span class="line">    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><br><span class="line">    livenessProbe:</span><br><span class="line">    exec:</span><br><span class="line">      command:</span><br><span class="line">      - cat</span><br><span class="line">      - /tmp/healthy</span><br><span class="line">    initialDelaySeconds: 5</span><br><span class="line">    periodSeconds: 5</span><br></pre></td></tr></table></figure>
<h3 id="17-创建-secret"><a href="#17-创建-secret" class="headerlink" title="17. 创建 secret"></a>17. 创建 secret</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-&gt; kubectl create secret generic my-secret --from-literal=a=b</span><br><span class="line">-&gt; echo xxx | base64 -d</span><br></pre></td></tr></table></figure>
<h3 id="18-将-secret-通过-volume-绑定在-pod-上"><a href="#18-将-secret-通过-volume-绑定在-pod-上" class="headerlink" title="18. 将 secret 通过 volume 绑定在 pod 上"></a>18. 将 secret 通过 volume 绑定在 pod 上</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: secrets-test-pod</span><br><span class="line">spec:</span><br><span class="line">  volume:</span><br><span class="line">  - name: secret-volume</span><br><span class="line">    secret:</span><br><span class="line">    - secretName: my-secret</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    name: test-container</span><br><span class="line">	volumeMounts:</span><br><span class="line">	- name: secret-volume</span><br><span class="line">	  path: /etc/secret/volume</span><br></pre></td></tr></table></figure>
<h3 id="19-将-secret-绑定在-env-上"><a href="#19-将-secret-绑定在-env-上" class="headerlink" title="19. 将 secret 绑定在 env 上"></a>19. 将 secret 绑定在 env 上</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: env-single-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: env1</span><br><span class="line">    image: nginx</span><br><span class="line">    env:</span><br><span class="line">    - name: SECRET_USERNAME</span><br><span class="line">      valueFrom:</span><br><span class="line">        secretKeyRef:</span><br><span class="line">          name: backend-user</span><br><span class="line">          key: backend-username</span><br></pre></td></tr></table></figure>
<h3 id="20-将-secret-所有键值对配置为容器环境变量"><a href="#20-将-secret-所有键值对配置为容器环境变量" class="headerlink" title="20. 将 secret 所有键值对配置为容器环境变量"></a>20. 将 secret 所有键值对配置为容器环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: envfrom-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: envvars-test-container</span><br><span class="line">    image: nginx</span><br><span class="line">    envFrom:</span><br><span class="line">    - secretRef:</span><br><span class="line">      name: test-secret</span><br></pre></td></tr></table></figure>
<h3 id="21-为-pod-添加-serviceAccountName"><a href="#21-为-pod-添加-serviceAccountName" class="headerlink" title="21. 为 pod 添加 serviceAccountName"></a>21. 为 pod 添加 serviceAccountName</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: my-pod</span><br><span class="line">spec:</span><br><span class="line">  serviceAccountName: build-robot</span><br></pre></td></tr></table></figure>
<h3 id="22-拉取私有仓库的镜像"><a href="#22-拉取私有仓库的镜像" class="headerlink" title="22.拉取私有仓库的镜像"></a>22.拉取私有仓库的镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-&gt; docker login</span><br><span class="line">-&gt; cat ~/.docker/config.json //查看config.json</span><br><span class="line">-&gt; kubectl create secret generic regcred \</span><br><span class="line">    --from-file=.dockerconfigjson=&lt;path/to/.docker/config.json&gt; \</span><br><span class="line">    --type=kubernetes.io/dockerconfigjson</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 为 pod 添加 imagePullSecrets</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: private-reg</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: private-reg-container</span><br><span class="line">    image: &lt;your-private-image&gt;</span><br><span class="line">  imagePullSecrets:</span><br><span class="line">  - name: regcred</span><br></pre></td></tr></table></figure>
<h3 id="23-为-pod-公开端口暴露给集群"><a href="#23-为-pod-公开端口暴露给集群" class="headerlink" title="23.为 pod 公开端口暴露给集群"></a>23.为 pod 公开端口暴露给集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: my-nginx</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        run: my-nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>
<h3 id="24-创建-service"><a href="#24-创建-service" class="headerlink" title="24.创建 service"></a>24.创建 service</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-&gt; kubectl expose deployment/my-nginx</span><br><span class="line">-&gt; kubectl get service my-nginx</span><br><span class="line">-&gt; kubectl get endpoint my-nginx</span><br><span class="line"></span><br><span class="line">// 或者 直接编辑 yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-nginx</span><br><span class="line">  labels:</span><br><span class="line">    run: my-nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    run: my-nginx</span><br></pre></td></tr></table></figure>
<h3 id="25-连接-service"><a href="#25-连接-service" class="headerlink" title="25. 连接 service"></a>25. 连接 service</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; kubectl exec my-nginx-3800858182-jr4a2 -- printenv | grep SERVICE</span><br></pre></td></tr></table></figure>
<h3 id="26-暴露-service"><a href="#26-暴露-service" class="headerlink" title="26. 暴露 service"></a>26. 暴露 service</h3><ul>
<li>nodePort 或 loadbalance </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl &lt;node-ip&gt;: nodePort</span><br><span class="line">curl &lt;externale-ip&gt;</span><br></pre></td></tr></table></figure>
<h3 id="27-有一组Pod，每个Pod都在TCP端口9376上侦听并带有标签”app-MyApp”"><a href="#27-有一组Pod，每个Pod都在TCP端口9376上侦听并带有标签”app-MyApp”" class="headerlink" title="27. 有一组Pod，每个Pod都在TCP端口9376上侦听并带有标签”app=MyApp”"></a>27. 有一组Pod，每个Pod都在TCP端口9376上侦听并带有标签”app=MyApp”</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">  	app: MyApp</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: tcp</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 9376</span><br></pre></td></tr></table></figure>
<h3 id="28-不带-selector-的-service-手动将-service-映射到运行它的网络地址和端口"><a href="#28-不带-selector-的-service-手动将-service-映射到运行它的网络地址和端口" class="headerlink" title="28.不带 selector 的 service,手动将 service 映射到运行它的网络地址和端口"></a>28.不带 selector 的 service,手动将 service 映射到运行它的网络地址和端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 9376</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">subsets:</span><br><span class="line">  - addresses:</span><br><span class="line">      - ip: 192.0.0.42</span><br><span class="line">    ports:</span><br><span class="line">      - port: 9376</span><br></pre></td></tr></table></figure>
<h3 id="29-服务发现"><a href="#29-服务发现" class="headerlink" title="29. 服务发现"></a>29. 服务发现</h3><ul>
<li>Kubernetes支持2种寻找服务的主要模式 - 环境变量和DNS。<br>I.”redis-master”公开TCP端口6379并已分配群集IP地址10.0.0.11的服务会生成以下环境变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">REDIS_MASTER_SERVICE_HOST=10.0.0.11</span><br><span class="line">REDIS_MASTER_SERVICE_PORT=6379</span><br><span class="line">REDIS_MASTER_PORT=tcp://10.0.0.11:6379</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP=tcp://10.0.0.11:6379</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP_PROTO=tcp</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP_PORT=6379</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP_ADDR=10.0.0.11</span><br></pre></td></tr></table></figure></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/">Kubernetes</a><span class="tag-list-count">1</span></li></ul></div><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kubernetes/">Kubernetes</a><span class="category-list-count">1</span></li></ul></div></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="cjybeodnq000f4tk9v0pyw1pz" data-title="Kubernetes Started" data-url="http://youhonglian.github.io/2019/07/20/ckad/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2018/03/14/docker-push/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/youhonglian" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://segmentfault.com/u/youzhiwan" title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li><li><a href="https://www.zhihu.com/people/jing-xiang-95-49/activities" title="zhihu" target="_blank"><i class="icon icon-zhihu"></i></a></li><li><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=994312463&amp;site=qq&amp;menu=yes" title="QQChat" target="_blank"><i class="icon icon-wechat"></i></a></li><li><a href="mailto:994312463@qq.com" title="Email" target="_blank"><i class="icon icon-email"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2019 Youuu<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>